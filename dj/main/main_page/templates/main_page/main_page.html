<!DOCTYPE html>
<html>
    {% include "main_page/header.html" %}

    <body>
        <div class="margins">
            <h1>–ó–∞–ø–∏—Å–∏ –æ –¥–≤–∏–∂–µ–Ω–∏–∏ –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</h1>

            <table id="cashflow-table" class="table table-bordered">
                <thead>
                    <tr>
                        <th scope="col">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th scope="col">–°—Ç–∞—Ç—É—Å</th>
                        <th scope="col">–¢–∏–ø</th>
                        <th scope="col">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th scope="col">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th scope="col">–°—É–º–º–∞</th>
                        <th scope="col">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        <th scope="col">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in posts %}
                    <tr>
                        <td>{{ p.date_create|date:'d.m.Y' }}</td>
                        <td>{{ p.status }}</td>
                        <td>{{ p.type_cashflow }}</td>
                        <td>{{ p.category }}</td>
                        <td>{{ p.subcategory }}</td>
                        <td>{{ p.sum_cashflow }} —Ä—É–±–ª–µ–π</td>
                        <td>{{ p.comment }}</td>
                        <td>
                            <button class="edit btn" 
                                    data-id="{{ p.id }}" 
                                    data-status="{{ p.status.id }}"
                                    data-type="{{ p.type_cashflow.id }}"
                                    data-category="{{ p.category.id }}"
                                    data-subcategory="{{ p.subcategory.id }}"
                                    data-sum="{{ p.sum_cashflow }}"
                                    data-comment="{{ p.comment }}">
                                ‚úèÔ∏è
                            </button>
                            <button class="delete-btn btn" data-record-id="{{ p.id }}">üóëÔ∏è</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            


           <!-- –ö–Ω–æ–ø–∫–∞-—Ç—Ä–∏–≥–≥–µ—Ä –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCashflowModal">
                + –ó–∞–ø–∏—Å—å
            </button>

            <!-- –ì—Ä—É–ø–ø–∞ –∫–Ω–æ–ø–æ–∫-—Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω -->
            <div class="btn-group" role="group" aria-label="Basic button group" style="margin-left: 20px;">
                <button type="button" class="btn btn-primary">+ –°—Ç–∞—Ç—É—Å</button>
                <button type="button" class="btn btn-primary">+ –¢–∏–ø</button>
                <button type="button" class="btn btn-primary">+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button>
                <button type="button" class="btn btn-primary">+ –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</button>
            </div>

            {% include "main_page/modals.html" %}
            
         </div>

         <script>
            document.addEventListener("DOMContentLoaded", function () {
                let categorySelect = document.getElementById("category");
                let subcategorySelect = document.getElementById("subcategory");
            
                categorySelect.addEventListener("change", function () {
                    let selectedCategory = this.value;
                    subcategorySelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
                    subcategorySelect.disabled = true;
            
                    fetch(`/get_subcategories/?category_id=${selectedCategory}`)
                        .then(response => response.json())
                        .then(data => {
                            subcategorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
                            data.forEach(subcategory => {
                                let option = document.createElement("option");
                                option.value = subcategory.id;
                                option.textContent = subcategory.name;
                                subcategorySelect.appendChild(option);
                            });
                            subcategorySelect.disabled = false;
                        })
                        .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π:", error));
                });
            });

            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".delete-btn").forEach(button => {
                    button.addEventListener("click", function () {
                        let recordId = this.dataset.recordId;
                        

                        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) {
                            fetch(`/delete_cashflow/${recordId}/`, {
                                method: "POST",
                                headers: { "X-CSRFToken": getCookie("csrftoken") },
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.message) {
                                    alert(data.message);
                                    location.reload();  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                                } else {
                                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
                                }
                            })
                            .catch(error => console.error("–û—à–∏–±–∫–∞:", error));
                        }
                    });
                });
            });

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF-—Ç–æ–∫–µ–Ω–∞
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== "") {
                    let cookies = document.cookie.split(";");
                    for (let i = 0; i < cookies.length; i++) {
                        let cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + "=")) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            
            </script>
    </body>
    
    {% include "main_page/footer.html" %}

    <script>
        $(document).ready(function() {
            $('.edit').click(function() {
                let recordId = $(this).data('id');

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                $('#cashflowForm select[name="status"]').val($(this).data('status'));
                $('#cashflowForm select[name="type_cashflow"]').val($(this).data('type'));
                $('#cashflowForm select[name="category"]').val($(this).data('category')).change(); // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                $('#cashflowForm select[name="subcategory"]').val($(this).data('subcategory'));
                $('#cashflowForm input[name="sum_cashflow"]').val($(this).data('sum'));
                $('#cashflowForm textarea[name="comment"]').val($(this).data('comment'));

                // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–∫–Ω–∞
                $('#addCashflowModalLabel').text('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å');

                // –ú–µ–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
                $('#saveRecord').attr('data-edit-id', recordId); // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∑–∞–ø–∏—Å–∏

                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                $('#addCashflowModal').modal('show');
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
            $('#saveRecord').click(function(event) {
                event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã

                let category = $('#cashflowForm select[name="category"]').val();
                let subcategory = $('#cashflowForm select[name="subcategory"]').val();
                let sumCashflow = $('#cashflowForm input[name="sum_cashflow"]').val();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω—ã –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è
                if (!category || category === "") {
                    alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏!");
                    return;
                }

                if (!subcategory || subcategory === "") {
                    alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏!");
                    return;
                }

                if (!sumCashflow || isNaN(sumCashflow) || parseFloat(sumCashflow) <= 0) {
                    alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!");
                    return;
                }

                let recordId = $(this).attr('data-edit-id'); // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ª–∏ –º—ã –∑–∞–ø–∏—Å—å
                let formData = $('#cashflowForm').serialize();
                let url = recordId ? `/edit_cashflow/${recordId}/` : "{% url 'add_cashflow' %}"; // –í—ã–±–∏—Ä–∞–µ–º URL

                $.ajax({
                    type: "POST",
                    url: url,
                    data: formData,
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                    success: function(response) {
                        location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    },
                    error: function(error) {
                        console.log("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error);
                    }
                });
            });

            $("button:contains('+ –°—Ç–∞—Ç—É—Å')").click(function() {
                $('#addStatusModal').modal('show');
            });

            // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–Ω–æ–ø–æ–∫:
            $("button:contains('+ –¢–∏–ø')").click(function() {
                $('#addTypeModal').modal('show');
            });

            $("button:contains('+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è')").click(function() {
                $('#addCategoryModal').modal('show');
            });

            $("button:contains('+ –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è')").click(function() {
                $('#addSubcategoryModal').modal('show');
            });

            function sendData(formId, url, modalId) {
                let formData = $(formId).serialize();
                $.ajax({
                    type: "POST",
                    url: url,
                    data: formData,
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                    success: function(response) {
                        alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
                        $(modalId).modal("hide");
                        location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                    },
                    error: function(error) {
                        console.log("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error);
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö!");
                    }
                });
            }

            $("#saveStatus").click(function() {
                sendData("#statusForm", "{% url 'add_status' %}", "#addStatusModal");
            });

            $("#saveType").click(function() {
                sendData("#typeForm", "{% url 'add_type' %}", "#addTypeModal");
            });

            $("#saveCategory").click(function() {
                sendData("#categoryForm", "{% url 'add_category' %}", "#addCategoryModal");
            });

            $("#saveSubcategory").click(function() {
                sendData("#subcategoryForm", "{% url 'add_subcategory' %}", "#addSubcategoryModal");
            });


            });
    </script>

</html>